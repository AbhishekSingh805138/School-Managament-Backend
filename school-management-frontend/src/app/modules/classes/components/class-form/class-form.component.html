<h2 mat-dialog-title>{{ isEditMode ? 'Edit Class' : 'Create New Class' }}</h2>

<mat-dialog-content>
  <form [formGroup]="classForm" class="class-form">
    <!-- Loading State -->
    <div *ngIf="isLoadingData" class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading form data...</p>
    </div>

    <div *ngIf="!isLoadingData" class="form-fields">
      <!-- Class Name -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Class Name</mat-label>
        <input matInput formControlName="name" placeholder="e.g., Grade 10-A" />
        <mat-error *ngIf="classForm.get('name')?.hasError('required')">
          Class name is required
        </mat-error>
        <mat-error *ngIf="classForm.get('name')?.hasError('maxLength')">
          Class name must be less than 100 characters
        </mat-error>
      </mat-form-field>

      <!-- Grade and Section Row -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Grade</mat-label>
          <mat-select formControlName="grade">
            <mat-option *ngFor="let grade of gradeOptions" [value]="grade">
              Grade {{ grade }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="classForm.get('grade')?.hasError('required')">
            Grade is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Section</mat-label>
          <mat-select formControlName="section">
            <mat-option *ngFor="let section of sectionOptions" [value]="section">
              Section {{ section }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="classForm.get('section')?.hasError('required')">
            Section is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Academic Year -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Academic Year</mat-label>
        <mat-select formControlName="academicYearId">
          <mat-option *ngFor="let year of academicYears" [value]="year.id">
            {{ year.name }}
          </mat-option>
        </mat-select>
        <mat-hint *ngIf="academicYears.length === 0" style="color: orange;">
          Loading academic years... (Found: {{ academicYears.length }})
        </mat-hint>
        <mat-error *ngIf="classForm.get('academicYearId')?.hasError('required')">
          Academic year is required
        </mat-error>
      </mat-form-field>

      <!-- Class Teacher -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Class Teacher (Optional)</mat-label>
        <mat-select formControlName="teacherId">
          <mat-option [value]="">None</mat-option>
          <mat-option *ngFor="let teacher of teachers" [value]="teacher.id">
            {{ getTeacherName(teacher) }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Capacity and Room Row -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Capacity</mat-label>
          <input matInput type="number" formControlName="capacity" min="1" max="100" />
          <mat-error *ngIf="classForm.get('capacity')?.hasError('required')">
            Capacity is required
          </mat-error>
          <mat-error *ngIf="classForm.get('capacity')?.hasError('min')">
            Capacity must be at least 1
          </mat-error>
          <mat-error *ngIf="classForm.get('capacity')?.hasError('max')">
            Capacity cannot exceed 100
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Room (Optional)</mat-label>
          <input matInput formControlName="room" placeholder="e.g., Room 101" />
          <mat-error *ngIf="classForm.get('room')?.hasError('maxLength')">
            Room must be less than 50 characters
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Description -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description (Optional)</mat-label>
        <textarea 
          matInput 
          formControlName="description" 
          rows="3"
          placeholder="Additional information about the class"
        ></textarea>
        <mat-error *ngIf="classForm.get('description')?.hasError('maxLength')">
          Description must be less than 500 characters
        </mat-error>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isSubmitting">
    Cancel
  </button>
  <button 
    mat-raised-button 
    color="primary" 
    (click)="onSubmit()" 
    [disabled]="isSubmitting || isLoadingData"
  >
    <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
    <span *ngIf="!isSubmitting">{{ isEditMode ? 'Update' : 'Create' }}</span>
  </button>
</mat-dialog-actions>
